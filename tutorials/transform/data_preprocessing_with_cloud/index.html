
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../assets/tf_full_color_primary_icon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Data preprocessing for ML with Google Cloud - TFX</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#data-preprocessing-for-ml-with-google-cloud" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="TFX" class="md-header__button md-logo" aria-label="TFX" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TFX
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Data preprocessing for ML with Google Cloud
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/tensorflow/tfx" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    TFX
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="TFX" class="md-nav__button md-logo" aria-label="TFX" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    TFX
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tensorflow/tfx" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    TFX
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Get started with TFX
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    TFX: Getting started tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            TFX: Getting started tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/penguin_simple" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Starter pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/penguin_tfdv" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Adding data validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/penguin_tft" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Adding feature engineering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/penguin_tfma" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Adding model analysis
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    TFX: Interactive tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            TFX: Interactive tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/components_keras" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interactive tutorial (TF2 Keras)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/components" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interactive tutorial (Estimator)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    TFX on Google Cloud
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            TFX on Google Cloud
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/gcp/vertex_pipelines_simple" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running on Vertex Pipelines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/gcp/vertex_pipelines_bq" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Read data from BigQuery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/gcp/vertex_pipelines_vertex_training" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vertex AI Training and Serving
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/cloud-ai-platform-pipelines" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud AI Platform Pipelines tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    TFX: Advanced tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            TFX: Advanced tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/gpt2_finetuning_and_conversion" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LLM finetuning and conversion
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/python_function_component" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom component tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/recommenders" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Recommenders with TFX
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/recommenders/examples/ranking_tfx" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ranking with TFX
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/airflow_workshop" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Airflow tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/neural_structured_learning" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Neural Structured Learning in TFX
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data Validation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Data Validation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data_validation/tfdv_basic" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Get started with TFDV
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Transform
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            Transform
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../simple" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprocess data (beginner)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../census" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprocess data (advanced)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data preprocessing for ML with Google Cloud
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Model Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            Model Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model_analysis/tfma_basic" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Get started with TFMA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/responsible_ai/fairness_indicators/tutorials/Fairness_Indicators_Example_Colab" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fairness Indicators tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Deploy a trained model
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            Deploy a trained model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../serving/rest_simple" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Servers: TFX for TensorFlow Serving
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/tfx_for_mobile" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mobile & IoT: TFX for TensorFlow Lite
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
        
          
          <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ML Metadata
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10">
            <span class="md-nav__icon md-icon"></span>
            ML Metadata
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mlmd/mlmd_tutorial" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Get started with MLMD
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    What's New
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            What's New
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/addons" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TFX-Addons
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/solutions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TFX Cloud Solutions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/keras" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Keras with TFX
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/non_tf" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Non-TensorFlow Frameworks in TFX
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tfx/tfx_for_mobile" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mobile & IoT: TFX for TensorFlow Lite
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    TFX Pipelines
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            TFX Pipelines
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/understanding_tfx_pipelines" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding TFX pipelines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/build_tfx_pipeline" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building a TFX pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/build_local_pipeline" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Local Pipelines
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    TFX Standard Components
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            TFX Standard Components
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/examplegen" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ExampleGen
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/statsgen" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    StatisticsGen
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/schemagen" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SchemaGen
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/exampleval" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ExampleValidator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/transform" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/trainer" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Trainer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/tuner" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tuner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/evaluator" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Evaluator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/infra_validator" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    InfraValidator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/pusher" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pusher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/bulkinferrer" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BulkInferrer
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    TFX Custom Components
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            TFX Custom Components
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/understanding_custom_components" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding custom components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/custom_function_component" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python function-based components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/container_component" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Container-based components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/custom_component" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fully custom components
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Orchestrators
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            Orchestrators
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/local_orchestrator" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Local orchestrator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/vertex" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vertex AI Pipelines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/airflow" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache Airflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/kubeflow" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubeflow Pipelines
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    TFX CLI
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            TFX CLI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/cli" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using the TFX CLI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Libraries
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            Libraries
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8_1" >
        
          
          <label class="md-nav__link" for="__nav_3_8_1" id="__nav_3_8_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data Validation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8_1">
            <span class="md-nav__icon md-icon"></span>
            Data Validation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/tfdv" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Check and analyze data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/data_validation/install" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/data_validation/get_started" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Get started
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8_2" >
        
          
          <label class="md-nav__link" for="__nav_3_8_2" id="__nav_3_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Transform
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8_2">
            <span class="md-nav__icon md-icon"></span>
            Transform
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/tft" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprocess and transform data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/transform/install" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/transform/get_started" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Get started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/transform/tf2_support" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using `tf.Transform` with TensorFlow 2.x
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/transform/common_transformations" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Common transformations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/tft_bestpractices" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data preprocessing best practices
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8_3" >
        
          
          <label class="md-nav__link" for="__nav_3_8_3" id="__nav_3_8_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modeling
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8_3">
            <span class="md-nav__icon md-icon"></span>
            Modeling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/train" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design modeling code
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8_4" >
        
          
          <label class="md-nav__link" for="__nav_3_8_4" id="__nav_3_8_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Model Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8_4">
            <span class="md-nav__icon md-icon"></span>
            Model Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/tfma" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Improving Model Quality
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/model_analysis/install" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/model_analysis/get_started" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Get started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/model_analysis/setup" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/model_analysis/metrics" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metrics and Plots
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/model_analysis/visualizations" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Visualizations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/model_analysis/model_validations" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model Validations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/fairness_indicators" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Fairness Indicators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/responsible_ai/fairness_indicators/tutorials/Fairness_Indicators_Pandas_Case_Study" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Fairness Indicators with Pandas DataFrames
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/model_analysis/architecture" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/model_analysis/faq" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8_5" >
        
          
          <label class="md-nav__link" for="__nav_3_8_5" id="__nav_3_8_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Serving
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_8_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8_5">
            <span class="md-nav__icon md-icon"></span>
            Serving
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/serving" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Serving models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/docker" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TensorFlow Serving with Docker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/setup" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/serving_basic" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Serve a TensorFlow model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/architecture" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/serving_config" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced model server configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/serving_advanced" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build a TensorFlow ModelServer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/serving_kubernetes" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Use TensorFlow Serving with Kubernetes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/custom_servable" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Create a new kind of servable
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/custom_source" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Create a module that discovers new servable paths
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/custom_op" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Serving TensorFlow models with custom ops
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tfx/serving/signature_defs" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SignatureDefs in SavedModel for TensorFlow Serving
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_9" >
        
          
          <label class="md-nav__link" for="__nav_3_9" id="__nav_3_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Related projects
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            Related projects
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://beam.apache.org/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache Beam
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://cloud.google.com/dataflow/docs/machine-learning/ml-preprocess-data" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MLTransform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guide/mlmd" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ML Metadata
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.tensorflow.org/tensorboard" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TensorBoard
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    v1
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            v1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/v1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/v1/components" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/v1/dsl" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dsl
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/v1/extensions" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    extensions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/v1/orchestration" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    orchestration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/v1/proto" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    proto
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/v1/testing" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/v1/types" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/v1/utils" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#costs" class="md-nav__link">
    <span class="md-ellipsis">
      Costs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#before-you-begin" class="md-nav__link">
    <span class="md-ellipsis">
      Before you begin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jupyter-notebooks-for-this-solution" class="md-nav__link">
    <span class="md-ellipsis">
      Jupyter notebooks for this solution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#launch-a-user-managed-notebooks-instance" class="md-nav__link">
    <span class="md-ellipsis">
      Launch a user-managed notebooks instance
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clone-the-notebook" class="md-nav__link">
    <span class="md-ellipsis">
      Clone the notebook
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implement-the-apache-beam-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Implement the Apache Beam pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implement the Apache Beam pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-notebook-1" class="md-nav__link">
    <span class="md-ellipsis">
      Run Notebook 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overview-of-the-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Overview of the pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-raw-training-data-from-bigquery" class="md-nav__link">
    <span class="md-ellipsis">
      Read raw training data from BigQuery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transform-raw-training-data" class="md-nav__link">
    <span class="md-ellipsis">
      Transform raw training data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Transform raw training data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-analyze-phase" class="md-nav__link">
    <span class="md-ellipsis">
      The analyze phase
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-transform-phase" class="md-nav__link">
    <span class="md-ellipsis">
      The transform phase
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-transformed-training-data" class="md-nav__link">
    <span class="md-ellipsis">
      Write transformed training data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-transform-and-write-evaluation-data" class="md-nav__link">
    <span class="md-ellipsis">
      Read, transform, and write evaluation data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#save-the-graph" class="md-nav__link">
    <span class="md-ellipsis">
      Save the graph
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-the-pipeline-in-dataflow" class="md-nav__link">
    <span class="md-ellipsis">
      Run the pipeline in Dataflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implement-the-tensorflow-model" class="md-nav__link">
    <span class="md-ellipsis">
      Implement the TensorFlow model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implement the TensorFlow model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-notebook-2" class="md-nav__link">
    <span class="md-ellipsis">
      Run Notebook 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overview-of-the-model-creation" class="md-nav__link">
    <span class="md-ellipsis">
      Overview of the model creation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-the-generated-transform-artifacts-in-model-training" class="md-nav__link">
    <span class="md-ellipsis">
      Use the generated transform artifacts in model training
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Use the generated transform artifacts in model training">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parse-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Parse the data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-feature-columns" class="md-nav__link">
    <span class="md-ellipsis">
      Create the feature columns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#export-the-model-for-serving-prediction" class="md-nav__link">
    <span class="md-ellipsis">
      Export the model for serving prediction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#train-and-use-the-model-for-predictions" class="md-nav__link">
    <span class="md-ellipsis">
      Train and use the model for predictions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clean-up" class="md-nav__link">
    <span class="md-ellipsis">
      Clean up
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Clean up">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delete-the-project" class="md-nav__link">
    <span class="md-ellipsis">
      Delete the project
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#whats-next" class="md-nav__link">
    <span class="md-ellipsis">
      What's next
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/tensorflow/tfx/edit/master/docs/tutorials/transform/data_preprocessing_with_cloud.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="data-preprocessing-for-ml-with-google-cloud">Data preprocessing for ML with Google Cloud<a class="headerlink" href="#data-preprocessing-for-ml-with-google-cloud" title="Permanent link"></a></h1>
<p>This tutorial shows you how to use
<a class="external" href="https://github.com/tensorflow/transform">TensorFlow Transform</a>
(the <code>tf.Transform</code> library) to implement data preprocessing for machine
learning (ML). The <code>tf.Transform</code> library for TensorFlow lets you
define both instance-level and full-pass data transformations through data
preprocessing pipelines. These pipelines are efficiently executed with
<a class="external" href="https://beam.apache.org/">Apache Beam</a>
and they create as byproducts a TensorFlow graph to apply the
same transformations during prediction as when the model is served.</p>
<p>This tutorial provides an end-to-end example using
<a href="https://cloud.google.com/dataflow/docs">Dataflow</a>
as a runner for Apache Beam. It assumes that you're familiar with
<a href="https://cloud.google.com/bigquery/docs">BigQuery</a>,
Dataflow,
<a href="https://cloud.google.com/vertex-ai/docs/start/introduction-unified-platform">Vertex AI</a>,
and the TensorFlow
<a href="https://www.tensorflow.org/guide/keras/overview">Keras</a>
API. It also assumes that you have some experience using Jupyter Notebooks, such
as with
<a href="https://cloud.google.com/vertex-ai/docs/workbench/introduction">Vertex AI Workbench</a>.</p>
<p>This tutorial also assumes that you're familiar with the concepts of
preprocessing types, challenges, and options on Google Cloud, as described in
<a href="../../guide/tft_bestpractices">Data preprocessing for ML: options and recommendations</a>.</p>
<h2 id="objectives">Objectives<a class="headerlink" href="#objectives" title="Permanent link"></a></h2>
<ul>
<li>Implement the Apache Beam pipeline using the <code>tf.Transform</code> library.</li>
<li>Run the pipeline in Dataflow.</li>
<li>Implement the TensorFlow model using the <code>tf.Transform</code>
    library.</li>
<li>Train and use the model for predictions.</li>
</ul>
<h2 id="costs">Costs<a class="headerlink" href="#costs" title="Permanent link"></a></h2>
<p>This tutorial uses the following billable components of Google Cloud:</p>
<ul>
<li><a class="external" href="https://cloud.google.com/vertex-ai/pricing">Vertex AI</a></li>
<li><a class="external" href="https://cloud.google.com/storage/pricing">Cloud Storage</a></li>
<li><a class="external" href="https://cloud.google.com/bigquery/pricing">BigQuery</a></li>
<li><a class="external" href="https://cloud.google.com/dataflow/pricing">Dataflow</a></li>
</ul>
<!-- This doc uses plain text cost information because the pricing calculator is pre-configured -->

<p>To estimate the cost to run this tutorial, please refer to
<a href="https://cloud.google.com/products/calculator">pricing calculator</a>.</p>
<h2 id="before-you-begin">Before you begin<a class="headerlink" href="#before-you-begin" title="Permanent link"></a></h2>
<ol>
<li>
<p>In the Google Cloud console, on the project selector page, select or
  <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects">create a Google Cloud project</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you don't plan to keep the resources that you create in this
procedure, create a project instead of selecting an existing project.
After you finish these steps, you can delete the project, removing all
resources associated with the project.</p>
</div>
</li>
</ol>
<p><a class="md-button md-button--primary" href="https://console.cloud.google.com/projectselector2/home/dashboard">Go to project selector</a></p>
<ol>
<li>
<p>Make sure that billing is enabled for your Cloud project. Learn how to
  <a href="https://cloud.google.com/billing/docs/how-to/verify-billing-enabled">check if billing is enabled on a project</a>.</p>
</li>
<li>
<p>Enable the Dataflow, Vertex AI, and Notebooks APIs.</p>
</li>
</ol>
<p><a class="md-button md-button--primary" href="https://console.cloud.google.com/flows/enableapi?apiid=dataflow,aiplatform.googleapis.com,notebooks.googleapis.com">Enable the APIs</a></p>
<h2 id="jupyter-notebooks-for-this-solution">Jupyter notebooks for this solution<a class="headerlink" href="#jupyter-notebooks-for-this-solution" title="Permanent link"></a></h2>
<p>The following Jupyter notebooks show the implementation example:</p>
<ul>
<li><a href="https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/babyweight_tft/babyweight_tft_keras_01.ipynb">Notebook 1</a>
    covers data preprocessing. Details are provided in the
    <a href="#implement-the-apache-beam-pipeline">Implementing the Apache Beam pipeline</a>
    section later.</li>
<li><a href="https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/babyweight_tft/babyweight_tft_keras_02.ipynb">Notebook 2</a>
    covers model training. Details are provided in the
    <a href="#implement-the-tensorflow-model">Implementing the TensorFlow model</a>
    section later.</li>
</ul>
<p>In the following sections, you clone these notebooks, and then you execute the
notebooks to learn how the implementation example works.</p>
<h2 id="launch-a-user-managed-notebooks-instance">Launch a user-managed notebooks instance<a class="headerlink" href="#launch-a-user-managed-notebooks-instance" title="Permanent link"></a></h2>
<ol>
<li>
<p>In the Google Cloud console, go to the <strong>Vertex AI Workbench</strong> page.</p>
<p><a class="md-button md-button--primary" href="https://console.cloud.google.com/ai-platform/notebooks/list/instances">Go to Workbench</a></p>
</li>
<li>
<p>On the <strong>User-managed notebooks</strong> tab, click <strong>+New notebook</strong>.</p>
</li>
<li>Select <strong>TensorFlow Enterprise 2.8 (with LTS) without GPUs</strong> for the
    instance type.</li>
<li>Click <strong>Create</strong>.</li>
</ol>
<p>After you create the notebook, wait for the proxy to JupyterLab to finish
initializing. When it's ready, <strong>Open JupyterLab</strong> is displayed next to the
notebook name.</p>
<h2 id="clone-the-notebook">Clone the notebook<a class="headerlink" href="#clone-the-notebook" title="Permanent link"></a></h2>
<ol>
<li>
<p>On the <strong>User-managed notebooks tab</strong>, next to the notebook name, click
    <strong>Open JupyterLab</strong>. The JupyterLab interface opens in a new tab.</p>
<p>If the JupyterLab displays a <strong>Build Recommended</strong> dialog, click
<strong>Cancel</strong> to reject the suggested build.
1.  On the <strong>Launcher</strong> tab, click <strong>Terminal</strong>.
1.  In the terminal window, clone the notebook:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/GoogleCloudPlatform/training-data-analyst
</span></code></pre></div>
</li>
</ol>
<h2 id="implement-the-apache-beam-pipeline">Implement the Apache Beam pipeline<a class="headerlink" href="#implement-the-apache-beam-pipeline" title="Permanent link"></a></h2>
<p>This section and the next section
<a href="#run-the-pipeline-in-dataflow">Run the pipeline in Dataflow</a>
provide an overview and context for Notebook 1. The notebook provides a
practical example to describe how to use the <code>tf.Transform</code> library to
preprocess data. This example uses the Natality dataset, which is used to
predict baby weights based on various inputs. The data is stored in the public
<a href="https://console.cloud.google.com/bigquery?p=bigquery-public-data&amp;d=samples&amp;t=natality&amp;page=table&amp;_ga=2.267763789.2122871960.1676620306-376763843.1676620306">natality</a>
table in BigQuery.</p>
<h3 id="run-notebook-1">Run Notebook 1<a class="headerlink" href="#run-notebook-1" title="Permanent link"></a></h3>
<ol>
<li>
<p>In the JupyterLab interface, click <strong>File &gt; Open from path</strong>, and
    then enter the following path:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>training-data-analyst/blogs/babyweight_tft/babyweight_tft_keras_01.ipynb
</span></code></pre></div>
</li>
<li>
<p>Click <strong>Edit &gt; Clear all outputs</strong>.</p>
</li>
<li>
<p>In the <strong>Install required packages</strong> section, execute the first cell to
    run the <code>pip install apache-beam</code> command.</p>
<p>The last part of the output is the following:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Successfully installed ...
</span></code></pre></div>
<p>You can ignore dependency errors in the output. You don't need to restart
the kernel yet.</p>
</li>
<li>
<p>Execute the second cell to run the <code>pip install tensorflow-transform</code>command. The last part of the output is the following:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>Successfully installed ...
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>Note: you may need to restart the kernel to use updated packages.
</span></code></pre></div>
<p>You can ignore dependency errors in the output.</p>
</li>
<li>
<p>Click <strong>Kernel &gt; Restart Kernel</strong>.</p>
</li>
<li>Execute the cells in the <strong>Confirm the installed packages</strong> and <strong>Create
    setup.py to install packages to Dataflow containers</strong> sections.</li>
<li>In the <strong>Set global flags</strong> section, next to <code>PROJECT</code> and <code>BUCKET</code>, replace
    <code>your-project</code> with your Cloud project ID, and
    then execute the cell.</li>
<li>Execute all of the remaining cells through the last cell in the notebook.
    For information about what to do in each cell, see the instructions in the
    notebook.</li>
</ol>
<h3 id="overview-of-the-pipeline">Overview of the pipeline<a class="headerlink" href="#overview-of-the-pipeline" title="Permanent link"></a></h3>
<p>In the notebook example, Dataflow runs the <code>tf.Transform</code>
pipeline at scale to prepare the data and produce the transformation artifacts.
Later sections in this document describe the functions that perform each step in
the pipeline. The overall pipeline steps are as follows:</p>
<ol>
<li>Read training data from BigQuery.</li>
<li>Analyze and transform training data using the <code>tf.Transform</code> library.</li>
<li>Write transformed training data to Cloud Storage in the
    <a href="https://www.tensorflow.org/tutorials/load_data/tfrecord">TFRecord</a>
    format.</li>
<li>Read evaluation data from BigQuery.</li>
<li>Transform evaluation data using the <code>transform_fn</code> graph produced by step 2.</li>
<li>Write transformed training data to Cloud Storage in the
    TFRecord format.</li>
<li>Write transformation artifacts to Cloud Storage that will be used
    later for creating and exporting the model.</li>
</ol>
<p>The following example shows the Python code for the overall pipeline. The
sections that follow provide explanations and code listings for each step.</p>
<div class="language-py yaml no-copy highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_transformation_pipeline</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="n">pipeline_options</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">PipelineOptions</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="n">runner</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">'runner'</span><span class="p">]</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="n">data_size</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">'data_size'</span><span class="p">]</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="n">transformed_data_location</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">'transformed_data_location'</span><span class="p">]</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="n">transform_artefact_location</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">'transform_artefact_location'</span><span class="p">]</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="n">temporary_dir</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">'temporary_dir'</span><span class="p">]</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="n">debug</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">'debug'</span><span class="p">]</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="c1"># Instantiate the pipeline</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="k">with</span> <span class="n">beam</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">pipeline_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">pipeline</span><span class="p">:</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="k">with</span> <span class="n">impl</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">temporary_dir</span><span class="p">):</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>            <span class="c1"># Preprocess train data</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>            <span class="n">step</span> <span class="o">=</span> <span class="s1">'train'</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>            <span class="c1"># Read raw train data from BigQuery</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>            <span class="n">raw_train_dataset</span> <span class="o">=</span> <span class="n">read_from_bq</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">data_size</span><span class="p">)</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>            <span class="c1"># Analyze and transform raw_train_dataset</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>            <span class="n">transformed_train_dataset</span><span class="p">,</span> <span class="n">transform_fn</span> <span class="o">=</span> <span class="n">analyze_and_transform</span><span class="p">(</span><span class="n">raw_train_dataset</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>            <span class="c1"># Write transformed train data to sink as tfrecords</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>            <span class="n">write_tfrecords</span><span class="p">(</span><span class="n">transformed_train_dataset</span><span class="p">,</span> <span class="n">transformed_data_location</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>            <span class="c1"># Preprocess evaluation data</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>            <span class="n">step</span> <span class="o">=</span> <span class="s1">'eval'</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>            <span class="c1"># Read raw eval data from BigQuery</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>            <span class="n">raw_eval_dataset</span> <span class="o">=</span> <span class="n">read_from_bq</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">data_size</span><span class="p">)</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>            <span class="c1"># Transform eval data based on produced transform_fn</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>            <span class="n">transformed_eval_dataset</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">raw_eval_dataset</span><span class="p">,</span> <span class="n">transform_fn</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>            <span class="c1"># Write transformed eval data to sink as tfrecords</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>            <span class="n">write_tfrecords</span><span class="p">(</span><span class="n">transformed_eval_dataset</span><span class="p">,</span> <span class="n">transformed_data_location</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>            <span class="c1"># Write transformation artefacts</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>            <span class="n">write_transform_artefacts</span><span class="p">(</span><span class="n">transform_fn</span><span class="p">,</span> <span class="n">transform_artefact_location</span><span class="p">)</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>            <span class="c1"># (Optional) for debugging, write transformed data as text</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>            <span class="n">step</span> <span class="o">=</span> <span class="s1">'debug'</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>            <span class="c1"># Write transformed train data as text if debug enabled</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>            <span class="k">if</span> <span class="n">debug</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>                <span class="n">write_text</span><span class="p">(</span><span class="n">transformed_train_dataset</span><span class="p">,</span> <span class="n">transformed_data_location</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="read-raw-training-data-from-bigquery">Read raw training data from BigQuery<a class="headerlink" href="#read-raw-training-data-from-bigquery" title="Permanent link"></a></h3>
<p>The first step is to read the raw training data from BigQuery
using the <code>read_from_bq</code> function. This function returns a <code>raw_dataset</code> object
that is extracted from BigQuery. You pass a <code>data_size</code> value and
pass a <code>step</code> value of <code>train</code> or <code>eval</code>. The BigQuery source
query is constructed using the <code>get_source_query</code> function, as shown in the
following example:</p>
<div class="language-py yaml no-copy highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_from_bq</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">data_size</span><span class="p">):</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">source_query</span> <span class="o">=</span> <span class="n">get_source_query</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">data_size</span><span class="p">)</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="n">raw_data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>        <span class="n">pipeline</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>        <span class="o">|</span> <span class="s1">'</span><span class="si">{}</span><span class="s1"> - Read Data from BigQuery'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>                           <span class="n">beam</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">BigQuerySource</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">source_query</span><span class="p">,</span> <span class="n">use_standard_sql</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="o">|</span> <span class="s1">'</span><span class="si">{}</span><span class="s1"> - Clean up Data'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">prep_bq_row</span><span class="p">)</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="p">)</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    <span class="n">raw_metadata</span> <span class="o">=</span> <span class="n">create_raw_metadata</span><span class="p">()</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="n">raw_dataset</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">raw_metadata</span><span class="p">)</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="k">return</span> <span class="n">raw_dataset</span>
</span></code></pre></div>
<p>Before you perform the <code>tf.Transform</code> preprocessing, you might need to perform
typical Apache Beam-based processing, including Map, Filter, Group, and Window
processing. In the example, the code cleans the records read from
BigQuery using the <code>beam.Map(prep_bq_row)</code> method, where
<code>prep_bq_row</code> is a custom function. This custom function converts the numeric
code for a categorical feature into human-readable labels.</p>
<p>In addition, to use the <code>tf.Transform</code> library to analyze and transform the
<code>raw_data</code> object extracted from BigQuery, you need to create a
<code>raw_dataset</code> object, which is a tuple of <code>raw_data</code> and <code>raw_metadata</code> objects.
The <code>raw_metadata</code> object is created using the <code>create_raw_metadata</code> function,
as follows:</p>
<div class="language-py yaml no-copy highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">CATEGORICAL_FEATURE_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'is_male'</span><span class="p">,</span> <span class="s1">'mother_race'</span><span class="p">]</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">NUMERIC_FEATURE_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'mother_age'</span><span class="p">,</span> <span class="s1">'plurality'</span><span class="p">,</span> <span class="s1">'gestation_weeks'</span><span class="p">]</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">TARGET_FEATURE_NAME</span> <span class="o">=</span> <span class="s1">'weight_pounds'</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_raw_metadata</span><span class="p">():</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    <span class="n">feature_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>        <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">CATEGORICAL_FEATURE_NAMES</span><span class="p">]</span> <span class="o">+</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>        <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">NUMERIC_FEATURE_NAMES</span><span class="p">]</span> <span class="o">+</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>        <span class="p">[(</span><span class="n">TARGET_FEATURE_NAME</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))])</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="n">raw_metadata</span> <span class="o">=</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">DatasetMetadata</span><span class="p">(</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>        <span class="n">schema_utils</span><span class="o">.</span><span class="n">schema_from_feature_spec</span><span class="p">(</span><span class="n">feature_spec</span><span class="p">))</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="k">return</span> <span class="n">raw_metadata</span>
</span></code></pre></div>
<p>When you execute the cell in the notebook that immediately follows the cell that
defines this method, the content of the <code>raw_metadata.schema</code> object is
displayed. It includes the following columns:</p>
<ul>
<li><code>gestation_weeks</code> (type: <code>FLOAT</code>)</li>
<li><code>is_male</code> (type: <code>BYTES</code>)</li>
<li><code>mother_age</code> (type: <code>FLOAT</code>)</li>
<li><code>mother_race</code> (type: <code>BYTES</code>)</li>
<li><code>plurality</code> (type: <code>FLOAT</code>)</li>
<li><code>weight_pounds</code> (type: <code>FLOAT</code>)</li>
</ul>
<h3 id="transform-raw-training-data">Transform raw training data<a class="headerlink" href="#transform-raw-training-data" title="Permanent link"></a></h3>
<p>Imagine that you want to apply typical preprocessing transformations to the
input raw features of the training data in order to prepare it for ML. These
transformations include both full-pass and instance-level operations, as shown
in the following table:</p>
<table>
<thead>
<tr>
<th>Input feature</th>
<th>Transformation</th>
<th>Stats needed</th>
<th>Type</th>
<th>Output feature</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>weight_pound</code></td>
<td>None</td>
<td>None</td>
<td>NA</td>
<td><code>weight_pound</code></td>
</tr>
<tr>
<td><code>mother_age</code></td>
<td>Normalize</td>
<td>mean, var</td>
<td>Full-pass</td>
<td><code>mother_age_normalized</code></td>
</tr>
<tr>
<td><code>mother_age</code></td>
<td>Equal size bucketization</td>
<td>quantiles</td>
<td>Full-pass</td>
<td><code>mother_age_bucketized</code></td>
</tr>
<tr>
<td><code>mother_age</code></td>
<td>Compute the log</td>
<td>None</td>
<td>Instance-level</td>
<td><code>mother_age_log</code></td>
</tr>
<tr>
<td><code>plurality</code></td>
<td>Indicate if it is single or multiple babies</td>
<td>None</td>
<td>Instance-level</td>
<td><code>is_multiple</code></td>
</tr>
<tr>
<td><code>is_multiple</code></td>
<td>Convert nominal values to numerical index</td>
<td>vocab</td>
<td>Full-pass</td>
<td><code>is_multiple_index</code></td>
</tr>
<tr>
<td><code>gestation_weeks</code></td>
<td>Scale between 0 and 1</td>
<td>min, max</td>
<td>Full-pass</td>
<td><code>gestation_weeks_scaled</code></td>
</tr>
<tr>
<td><code>mother_race</code></td>
<td>Convert nominal values to numerical index</td>
<td>vocab</td>
<td>Full-pass</td>
<td><code>mother_race_index</code></td>
</tr>
<tr>
<td><code>is_male</code></td>
<td>Convert nominal values to numerical index</td>
<td>vocab</td>
<td>Full-pass</td>
<td><code>is_male_index</code></td>
</tr>
</tbody>
</table>
<p>These transformations are implemented in a <code>preprocess_fn</code> function, which
expects a dictionary of tensors (<code>input_features</code>) and returns a dictionary of
processed features (<code>output_features</code>).</p>
<p>The following code shows the implementation of the <code>preprocess_fn</code> function,
using the <code>tf.Transform</code> full-pass transformation APIs (prefixed with <code>tft.</code>),
and TensorFlow (prefixed with <code>tf.</code>) instance-level operations:</p>
<div class="language-py yaml no-copy highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">preprocess_fn</span><span class="p">(</span><span class="n">input_features</span><span class="p">):</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="n">output_features</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="c1"># target feature</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="n">output_features</span><span class="p">[</span><span class="s1">'weight_pounds'</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_features</span><span class="p">[</span><span class="s1">'weight_pounds'</span><span class="p">]</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    <span class="c1"># normalization</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="n">output_features</span><span class="p">[</span><span class="s1">'mother_age_normalized'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">scale_to_z_score</span><span class="p">(</span><span class="n">input_features</span><span class="p">[</span><span class="s1">'mother_age'</span><span class="p">])</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="c1"># scaling</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="n">output_features</span><span class="p">[</span><span class="s1">'gestation_weeks_scaled'</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tft</span><span class="o">.</span><span class="n">scale_to_0_1</span><span class="p">(</span><span class="n">input_features</span><span class="p">[</span><span class="s1">'gestation_weeks'</span><span class="p">])</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>    <span class="c1"># bucketization based on quantiles</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="n">output_features</span><span class="p">[</span><span class="s1">'mother_age_bucketized'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">bucketize</span><span class="p">(</span><span class="n">input_features</span><span class="p">[</span><span class="s1">'mother_age'</span><span class="p">],</span> <span class="n">num_buckets</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="c1"># you can compute new features based on custom formulas</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>    <span class="n">output_features</span><span class="p">[</span><span class="s1">'mother_age_log'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">input_features</span><span class="p">[</span><span class="s1">'mother_age'</span><span class="p">])</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>    <span class="c1"># or create flags/indicators</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>    <span class="n">is_multiple</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">as_string</span><span class="p">(</span><span class="n">input_features</span><span class="p">[</span><span class="s1">'plurality'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>    <span class="c1"># convert categorical features to indexed vocab</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>    <span class="n">output_features</span><span class="p">[</span><span class="s1">'mother_race_index'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">compute_and_apply_vocabulary</span><span class="p">(</span><span class="n">input_features</span><span class="p">[</span><span class="s1">'mother_race'</span><span class="p">],</span> <span class="n">vocab_filename</span><span class="o">=</span><span class="s1">'mother_race'</span><span class="p">)</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>    <span class="n">output_features</span><span class="p">[</span><span class="s1">'is_male_index'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">compute_and_apply_vocabulary</span><span class="p">(</span><span class="n">input_features</span><span class="p">[</span><span class="s1">'is_male'</span><span class="p">],</span> <span class="n">vocab_filename</span><span class="o">=</span><span class="s1">'is_male'</span><span class="p">)</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>    <span class="n">output_features</span><span class="p">[</span><span class="s1">'is_multiple_index'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">compute_and_apply_vocabulary</span><span class="p">(</span><span class="n">is_multiple</span><span class="p">,</span> <span class="n">vocab_filename</span><span class="o">=</span><span class="s1">'is_multiple'</span><span class="p">)</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>    <span class="k">return</span> <span class="n">output_features</span>
</span></code></pre></div>
<p>The <code>tf.Transform</code>
<a href="https://github.com/tensorflow/transform">framework</a>
has several other transformations in addition to those in the preceding example,
including those listed in the following table:</p>
<table>
<thead>
<tr>
<th>Transformation</th>
<th>Applies to</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>scale_by_min_max</code></td>
<td>Numeric features</td>
<td>Scales a numerical column into the range [<code>output_min</code>, <code>output_max</code>]</td>
</tr>
<tr>
<td><code>scale_to_0_1</code></td>
<td>Numeric features</td>
<td>Returns a column which is the input column scaled to have range [<code>0</code>,<code>1</code>]</td>
</tr>
<tr>
<td><code>scale_to_z_score</code></td>
<td>Numeric features</td>
<td>Returns a standardized column with mean 0 and variance 1</td>
</tr>
<tr>
<td><code>tfidf</code></td>
<td>Text features</td>
<td>Maps the terms in <em>x</em> to their term frequency * inverse document frequency</td>
</tr>
<tr>
<td><code>compute_and_apply_vocabulary</code></td>
<td>Categorical features</td>
<td>Generates a vocabulary for a categorical feature and maps it to an integer with this vocab</td>
</tr>
<tr>
<td><code>ngrams</code></td>
<td>Text features</td>
<td>Creates a <code>SparseTensor</code> of n-grams</td>
</tr>
<tr>
<td><code>hash_strings</code></td>
<td>Categorical features</td>
<td>Hashes strings into buckets</td>
</tr>
<tr>
<td><code>pca</code></td>
<td>Numeric features</td>
<td>Computes PCA on the dataset using biased covariance</td>
</tr>
<tr>
<td><code>bucketize</code></td>
<td>Numeric features</td>
<td>Returns an equal-sized (quantiles-based) bucketized column, with a bucket index assigned to each input</td>
</tr>
</tbody>
</table>
<p>In order to apply the transformations implemented in the <code>preprocess_fn</code>
function to the <code>raw_train_dataset</code> object produced in the previous step of the
pipeline, you use the <code>AnalyzeAndTransformDataset</code> method. This method expects
the <code>raw_dataset</code> object as input, applies the <code>preprocess_fn</code> function, and it
produces the <code>transformed_dataset</code> object and the <code>transform_fn</code> graph. The
following code illustrates this processing:</p>
<div class="language-py yaml no-copy highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">analyze_and_transform</span><span class="p">(</span><span class="n">raw_dataset</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">transformed_dataset</span><span class="p">,</span> <span class="n">transform_fn</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        <span class="n">raw_dataset</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>        <span class="o">|</span> <span class="s1">'</span><span class="si">{}</span><span class="s1"> - Analyze &amp; Transform'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">tft_beam</span><span class="o">.</span><span class="n">AnalyzeAndTransformDataset</span><span class="p">(</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>            <span class="n">preprocess_fn</span><span class="p">,</span> <span class="n">output_record_batches</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="p">)</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="k">return</span> <span class="n">transformed_dataset</span><span class="p">,</span> <span class="n">transform_fn</span>
</span></code></pre></div>
<p>The transformations are applied on the raw data in two phases: the analyze
phase and the transform phase. Figure 3 later in this document shows how the
<code>AnalyzeAndTransformDataset</code> method is decomposed to the <code>AnalyzeDataset</code> method
and the <code>TransformDataset</code> method.</p>
<h4 id="the-analyze-phase">The analyze phase<a class="headerlink" href="#the-analyze-phase" title="Permanent link"></a></h4>
<p>In the analyze phase, the raw training data is analyzed in a full-pass process
to compute the statistics that are needed for the transformations. This includes
computing the mean, variance, minimum, maximum, quantiles, and vocabulary. The
analyze process expects a raw dataset (raw data plus raw metadata), and it
produces two outputs:</p>
<ul>
<li><code>transform_fn</code>: a TensorFlow graph that contains the
    computed stats from the analyze phase and the transformation logic (which
    uses the stats) as instance-level operations. As discussed later in
    <a href="#save-the-graph">Save the graph</a>,
    the <code>transform_fn</code> graph is saved to be attached to the model <code>serving_fn</code>
    function. This makes it possible to apply the same transformation to the
    online prediction data points.</li>
<li><code>transform_metadata</code>: an object that describes the expected schema of
    the data after transformation.</li>
</ul>
<p>The analyze phase is illustrated in the following diagram, figure 1:</p>
<p><figure id="tf-transform-analyze-phase"><img alt="The tf.Transform analyze phase." src="../images/data-preprocessing-for-ml-with-tf-transform-tf-transform-analyze-phase.svg"><figcaption>Figure 1: The <code>tf.Transform</code> analyze phase. </figcaption></figure></p>
<p>The <code>tf.Transform</code>
<a href="https://github.com/tensorflow/transform/blob/master/tensorflow_transform/beam/analyzer_impls.py">analyzers</a>
include <code>min</code>, <code>max</code>, <code>sum</code>, <code>size</code>, <code>mean</code>, <code>var</code>, <code>covariance</code>, <code>quantiles</code>,
<code>vocabulary</code>, and <code>pca</code>.</p>
<h4 id="the-transform-phase">The transform phase<a class="headerlink" href="#the-transform-phase" title="Permanent link"></a></h4>
<p>In the transform phase, the <code>transform_fn</code> graph that's produced by the analyze
phase is used to transform the raw training data in an instance-level process in
order to produce the transformed training data. The transformed training data is
paired with the transformed metadata (produced by the analyze phase) to produce
the <code>transformed_train_dataset</code> dataset.</p>
<p>The transform phase is illustrated in the following diagram, figure 2:</p>
<p><figure id="tf-transform-transform-phase"><img alt="The tf.Transform transform phase." src="../images/data-preprocessing-for-ml-with-tf-transform-tf-transform-transform-phase.svg"><figcaption>Figure 2: The <code>tf.Transform</code> transform phase. </figcaption></figure></p>
<p>To preprocess the features, you call the required <code>tensorflow_transform</code>
transformations (imported as <code>tft</code> in the code) in your implementation of the
<code>preprocess_fn</code> function. For example, when you call the <code>tft.scale_to_z_score</code>
operations, the <code>tf.Transform</code> library translates this function call into mean
and variance analyzers, computes the stats in the analyze phase, and then
applies these stats to normalize the numeric feature in the transform phase.
This is all done automatically by calling the
<code>AnalyzeAndTransformDataset(preprocess_fn)</code> method.</p>
<p>The <code>transformed_metadata.schema</code> entity produced by this call includes the
following columns:</p>
<ul>
<li><code>gestation_weeks_scaled</code> (type: <code>FLOAT</code>)</li>
<li><code>is_male_index</code> (type: <code>INT</code>, is_categorical: <code>True</code>)</li>
<li><code>is_multiple_index</code> (type: <code>INT</code>, is_categorical: <code>True</code>)</li>
<li><code>mother_age_bucketized</code> (type: <code>INT</code>, is_categorical: <code>True</code>)</li>
<li><code>mother_age_log</code> (type: <code>FLOAT</code>)</li>
<li><code>mother_age_normalized</code> (type: <code>FLOAT</code>)</li>
<li><code>mother_race_index</code> (type: <code>INT</code>, is_categorical: <code>True</code>)</li>
<li><code>weight_pounds</code> (type: <code>FLOAT</code>)</li>
</ul>
<p>As explained in
<a href="../data-preprocessing-for-ml-with-tf-transform-pt1#preprocessing-operations">Preprocessing operations</a>
in the first part of this series, the feature transformation converts
categorical features to a numeric representation. After the transformation, the
categorical features are represented by integer values. In the
<code>transformed_metadata.schema</code> entity, the <code>is_categorical</code> flag for <code>INT</code> type
columns indicates whether the column represents a categorical feature or a true
numeric feature.</p>
<h3 id="write-transformed-training-data">Write transformed training data<a class="headerlink" href="#write-transformed-training-data" title="Permanent link"></a></h3>
<p>After the training data is preprocessed with the <code>preprocess_fn</code> function
through the analyze and transform phases, you can write the data to a sink to be
used for training the TensorFlow model. When you execute the Apache
Beam pipeline using Dataflow, the sink is Cloud Storage.
Otherwise, the sink is the local disk. Although you can write the data as a CSV
file of fixed-width formatted files, the recommended file format for
TensorFlow datasets is the TFRecord format. This is a simple
record-oriented binary format that consists of
<code>tf.train.Example</code> protocol buffer messages.</p>
<p>Each <code>tf.train.Example</code> record contains one or more features. These are
converted into tensors when they are fed to the model for training. The
following code writes the transformed dataset to TFRecord files in the specified
location:</p>
<div class="language-py yaml no-copy highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_tfrecords</span><span class="p">(</span><span class="n">transformed_dataset</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">tfx_bsl.coders</span><span class="w"> </span><span class="kn">import</span> <span class="n">example_coder</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="n">transformed_data</span><span class="p">,</span> <span class="n">transformed_metadata</span> <span class="o">=</span> <span class="n">transformed_dataset</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="p">(</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        <span class="n">transformed_data</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="o">|</span> <span class="s1">'</span><span class="si">{}</span><span class="s1"> - Encode Transformed Data'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMapTuple</span><span class="p">(</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>                            <span class="k">lambda</span> <span class="n">batch</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">example_coder</span><span class="o">.</span><span class="n">RecordBatchToExamples</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        <span class="o">|</span> <span class="s1">'</span><span class="si">{}</span><span class="s1"> - Write Transformed Data'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">WriteToTFRecord</span><span class="p">(</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>                            <span class="n">file_path_prefix</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">location</span><span class="p">,</span><span class="s1">'</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)),</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>                            <span class="n">file_name_suffix</span><span class="o">=</span><span class="s1">'.tfrecords'</span><span class="p">)</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="p">)</span>
</span></code></pre></div>
<h3 id="read-transform-and-write-evaluation-data">Read, transform, and write evaluation data<a class="headerlink" href="#read-transform-and-write-evaluation-data" title="Permanent link"></a></h3>
<p>After you transform the training data and produce the <code>transform_fn</code> graph, you
can use it to transform the evaluation data. First, you read and clean the
evaluation data from BigQuery using the <code>read_from_bq</code> function
described earlier in
<a href="#read-raw-training-data-from-bigquery">Read raw training data from BigQuery</a>,
and passing a value of <code>eval</code> for the <code>step</code> parameter. Then, you use the
following code to transform the raw evaluation dataset (<code>raw_dataset</code>) to the
expected transformed format (<code>transformed_dataset</code>):</p>
<div class="language-py yaml no-copy highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">raw_dataset</span><span class="p">,</span> <span class="n">transform_fn</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="n">transformed_dataset</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>        <span class="p">(</span><span class="n">raw_dataset</span><span class="p">,</span> <span class="n">transform_fn</span><span class="p">)</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>        <span class="o">|</span> <span class="s1">'</span><span class="si">{}</span><span class="s1"> - Transform'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">tft_beam</span><span class="o">.</span><span class="n">TransformDataset</span><span class="p">(</span><span class="n">output_record_batches</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="p">)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="k">return</span> <span class="n">transformed_dataset</span>
</span></code></pre></div>
<p>When you transform the evaluation data, only instance-level operations apply,
using both the logic in the <code>transform_fn</code> graph and the statistics computed
from the analyze phase in the training data. In other words, you don't analyze
the evaluation data in a full-pass fashion to compute new statistics, like the
mean and the variance for z-score normalization of numeric features in
evaluation data. Instead, you use the computed statistics from the training data
to transform the evaluation data in an instance-level fashion.</p>
<p>Therefore, you use the <code>AnalyzeAndTransform</code> method in the context of training
data to compute the statistics and transform the data. At the same time, you use
the <code>TransformDataset</code> method in the context of transforming evaluation data to
only transform the data using the statistics computed on the training data.</p>
<p>You then write the data to a sink (Cloud Storage or local disk,
depending on the runner) in the TFRecord format for evaluating the
TensorFlow model during the training process. To do this, you use
the <code>write_tfrecords</code> function that's discussed in
<a href="#write-transformed-training-data">Write transformed training data</a>.
The following diagram, figure 3, shows how the <code>transform_fn</code> graph that's
produced in the analyze phase of the training data is used to transform the
evaluation data.</p>
<p><figure id="transform-eval-data-using-transform-fn"><img alt="Transforming evaluation data using the transform_fn graph." src="../images/data-preprocessing-for-ml-with-tf-transform-transforming-eval-data-using-transform_fn.svg"><figcaption>Figure 3: Transforming evaluation data using the <code>transform_fn</code> graph. </figcaption></figure></p>
<h3 id="save-the-graph">Save the graph<a class="headerlink" href="#save-the-graph" title="Permanent link"></a></h3>
<p>A final step in the <code>tf.Transform</code> preprocessing pipeline is to store the
artifacts, which includes the <code>transform_fn</code> graph that's produced by the
analyze phase on the training data. The code for storing the artifacts is shown
in the following <code>write_transform_artefacts</code> function:</p>
<div class="language-py yaml no-copy highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_transform_artefacts</span><span class="p">(</span><span class="n">transform_fn</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="p">(</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>        <span class="n">transform_fn</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>        <span class="o">|</span> <span class="s1">'Write Transform Artifacts'</span> <span class="o">&gt;&gt;</span> <span class="n">transform_fn_io</span><span class="o">.</span><span class="n">WriteTransformFn</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>These artifacts will be used later for model training and exporting for serving.
The following artifacts are also produced, as shown in the next section:</p>
<ul>
<li><code>saved_model.pb</code>: represents the TensorFlow graph
    that includes the transformation logic (the <code>transform_fn</code> graph), which is
    to be attached to the model serving interface to transform the raw data
    points to the transformed format.</li>
<li><code>variables</code>: includes the statistics computed during the analyze
    phase of the training data, and is used in the transformation logic in the
    <code>saved_model.pb</code> artifact.</li>
<li><code>assets</code>: includes vocabulary files, one for each categorical feature
    processed with the <code>compute_and_apply_vocabulary</code> method, to be used
    during serving to convert an input raw nominal value to a numerical index.</li>
<li><code>transformed_metadata</code>: a directory that contains the <code>schema.json</code> file
    that describes the schema of the transformed data.</li>
</ul>
<h2 id="run-the-pipeline-in-dataflow">Run the pipeline in Dataflow<a class="headerlink" href="#run-the-pipeline-in-dataflow" title="Permanent link"></a></h2>
<p>After you define the <code>tf.Transform</code> pipeline, you run the pipeline using
Dataflow. The following diagram, figure 4, shows the
Dataflow execution graph of the <code>tf.Transform</code> pipeline described
in the example.</p>
<p><figure id="dataflow-execution-graph"><img alt="Dataflow execution graph of the tf.Transform pipeline." src="../images/data-preprocessing-for-ml-with-tf-transform-dataflow-execution-graph.png"><figcaption>Figure 4: Dataflow execution graph of the <code>tf.Transform</code> pipeline. </figcaption></figure></p>
<p>After you execute the Dataflow pipeline to preprocess the
training and evaluation data, you can explore the produced objects in
Cloud Storage by executing the last cell in the notebook. The code
snippets in this section show the results, where
<var><code>YOUR_BUCKET_NAME</code></var> is the name of your Cloud Storage
bucket.</p>
<p>The transformed training and evaluation data in TFRecord format are stored at
the following location:</p>
<div class="language-yaml no-copy highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transformed</span>
</span></code></pre></div>
<p>The transform artifacts are produced at the following location:</p>
<div class="language-yaml no-copy highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform</span>
</span></code></pre></div>
<p>The following list is the output of the pipeline, showing the produced data
objects and artifacts:</p>
<div class="language-yaml no-copy highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nt">transformed data</span><span class="p">:</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transformed/eval-00000-of-00001.tfrecords</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transformed/train-00000-of-00002.tfrecords</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transformed/train-00001-of-00002.tfrecords</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="nt">transformed metadata</span><span class="p">:</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transformed_metadata/</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transformed_metadata/asset_map</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transformed_metadata/schema.pbtxt</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="nt">transform artefact</span><span class="p">:</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transform_fn/</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transform_fn/saved_model.pb</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transform_fn/assets/</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transform_fn/variables/</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="nt">transform assets</span><span class="p">:</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transform_fn/assets/</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transform_fn/assets/is_male</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transform_fn/assets/is_multiple</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="l l-Scalar l-Scalar-Plain">gs://YOUR_BUCKET_NAME/babyweight_tft/transform/transform_fn/assets/mother_race</span>
</span></code></pre></div>
<h2 id="implement-the-tensorflow-model">Implement the TensorFlow model<a class="headerlink" href="#implement-the-tensorflow-model" title="Permanent link"></a></h2>
<p>This section and the next section,
<a href="#train-and-use-the-model-for-predictions">Train and use the model for predictions</a>,
provide an overview and context for Notebook 2. The notebook provides
an example ML model to predict baby weights. In this example, a
TensorFlow model is implemented using the Keras API. The model
uses the data and artifacts that are produced by the <code>tf.Transform</code>
preprocessing pipeline explained earlier.</p>
<h3 id="run-notebook-2">Run Notebook 2<a class="headerlink" href="#run-notebook-2" title="Permanent link"></a></h3>
<ol>
<li>
<p>In the JupyterLab interface, click <strong>File &gt; Open from path</strong>, and then
    enter the following path:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>training-data-analyst/blogs/babyweight_tft/babyweight_tft_keras_02.ipynb
</span></code></pre></div>
</li>
<li>
<p>Click <strong>Edit &gt; Clear all outputs</strong>.</p>
</li>
<li>
<p>In the <strong>Install required packages</strong> section, execute the first cell to run
    the <code>pip install tensorflow-transform</code> command.</p>
<p>The last part of the output is the following:</p>
<div class="language-yaml no-copy highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="l l-Scalar l-Scalar-Plain">Successfully installed ...</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="l l-Scalar l-Scalar-Plain">Note</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">you may need to restart the kernel to use updated packages.</span>
</span></code></pre></div>
<p>You can ignore dependency errors in the output.</p>
</li>
<li>
<p>In the <strong>Kernel</strong> menu, select <strong>Restart Kernel</strong>.</p>
</li>
<li>Execute the cells in the <strong>Confirm the installed packages</strong> and <strong>Create
    setup.py to install packages to Dataflow containers</strong> sections.</li>
<li>In the <strong>Set global flags</strong> section, next to <code>PROJECT</code> and <code>BUCKET</code>, replace
    <var><code>your-project</code></var> with your Cloud project ID, and
    then execute the cell.</li>
<li>Execute all of the remaining cells through the last cell in the notebook.
    For information about what to do in each cell, see the instructions in the
    notebook.</li>
</ol>
<h3 id="overview-of-the-model-creation">Overview of the model creation<a class="headerlink" href="#overview-of-the-model-creation" title="Permanent link"></a></h3>
<p>The steps for creating the model are as follows:</p>
<ol>
<li>Create feature columns using the schema information that is stored in the
    <code>transformed_metadata</code> directory.</li>
<li>Create the wide and deep model with the Keras API using the feature
    columns as input to the model.</li>
<li>Create the <code>tfrecords_input_fn</code> function to read and parse the training
    and evaluation data using the transform artifacts.</li>
<li>Train and evaluate the model.</li>
<li>Export the trained model by defining a <code>serving_fn</code> function that has the
    <code>transform_fn</code> graph attached to it.</li>
<li>Inspect the exported model using the
    <a href="https://www.tensorflow.org/guide/saved_model"><code>saved_model_cli</code></a>
    tool.</li>
<li>Use the exported model for prediction.</li>
</ol>
<p>This document doesn't explain how to build the model, so it doesn't discuss in
detail how the model was built or trained. However, the following sections show
how the information stored in the <code>transform_metadata</code> directorywhich is
produced by the <code>tf.Transform</code> processis used to create the feature columns of
the model. The document also shows how the <code>transform_fn</code> graphwhich is also
produced by <code>tf.Transform</code> processis used in the <code>serving_fn</code> function when the
model is exported for serving.</p>
<h3 id="use-the-generated-transform-artifacts-in-model-training">Use the generated transform artifacts in model training<a class="headerlink" href="#use-the-generated-transform-artifacts-in-model-training" title="Permanent link"></a></h3>
<p>When you train the TensorFlow model, you use the transformed
<code>train</code> and <code>eval</code> objects produced in the previous data processing step. These
objects are stored as sharded files in the TFRecord format. The schema
information in the <code>transformed_metadata</code> directory generated in the previous
step can be useful in parsing the data (<code>tf.train.Example</code> objects) to feed into
the model for training and evaluation.</p>
<h4 id="parse-the-data">Parse the data<a class="headerlink" href="#parse-the-data" title="Permanent link"></a></h4>
<p>Because you read files in the TFRecord format to feed the model with training
and evaluation data, you need to parse each <code>tf.train.Example</code> object in the
files to create a dictionary of features (tensors). This ensures that the
features are mapped to the model input layer using the feature columns, which
act as the model training and evaluation interface. To parse the data, you use
the <code>TFTransformOutput</code> object that is created from the artifacts generated in
the previous step:</p>
<ol>
<li>
<p>Create a <code>TFTransformOutput</code> object from the artifacts that are generated
    and saved in the previous preprocessing step, as described in the
    <a href="#save-the-graph">Save the graph</a>
    section:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">tf_transform_output</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">TFTransformOutput</span><span class="p">(</span><span class="n">TRANSFORM_ARTEFACTS_DIR</span><span class="p">)</span>
</span></code></pre></div>
</li>
<li>
<p>Extract a <code>feature_spec</code> object from the <code>TFTransformOutput</code> object:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">tf_transform_output</span><span class="o">.</span><span class="n">transformed_feature_spec</span><span class="p">()</span>
</span></code></pre></div>
</li>
<li>
<p>Use the <code>feature_spec</code> object to specify the features contained in the
    <code>tf.train.Example</code> object as in the <code>tfrecords_input_fn</code> function:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">tfrecords_input_fn</span><span class="p">(</span><span class="n">files_name_pattern</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>    <span class="n">tf_transform_output</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">TFTransformOutput</span><span class="p">(</span><span class="n">TRANSFORM_ARTEFACTS_DIR</span><span class="p">)</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="n">TARGET_FEATURE_NAME</span> <span class="o">=</span> <span class="s1">'weight_pounds'</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    <span class="n">batched_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">make_batched_features_dataset</span><span class="p">(</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>        <span class="n">file_pattern</span><span class="o">=</span><span class="n">files_name_pattern</span><span class="p">,</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>        <span class="n">features</span><span class="o">=</span><span class="n">tf_transform_output</span><span class="o">.</span><span class="n">transformed_feature_spec</span><span class="p">(),</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>        <span class="n">reader</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">,</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>        <span class="n">label_key</span><span class="o">=</span><span class="n">TARGET_FEATURE_NAME</span><span class="p">,</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>    <span class="k">return</span> <span class="n">batched_dataset</span>
</span></code></pre></div>
</li>
</ol>
<h4 id="create-the-feature-columns">Create the feature columns<a class="headerlink" href="#create-the-feature-columns" title="Permanent link"></a></h4>
<p>The pipeline produces the schema information in the <code>transformed_metadata</code>
directory that describes the schema of the transformed data that is expected by
the model for training and evaluation. The schema contains the feature name and
data type, such as the following:</p>
<ul>
<li><code>gestation_weeks_scaled</code> (type: <code>FLOAT</code>)</li>
<li><code>is_male_index</code> (type: <code>INT</code>, is_categorical: <code>True</code>)</li>
<li><code>is_multiple_index</code> (type: <code>INT</code>, is_categorical: <code>True</code>)</li>
<li><code>mother_age_bucketized</code> (type: <code>INT</code>, is_categorical: <code>True</code>)</li>
<li><code>mother_age_log</code> (type: <code>FLOAT</code>)</li>
<li><code>mother_age_normalized</code> (type: <code>FLOAT</code>)</li>
<li><code>mother_race_index</code> (type: <code>INT</code>, is_categorical: <code>True</code>)</li>
<li><code>weight_pounds</code> (type: <code>FLOAT</code>)</li>
</ul>
<p>To see this information, use the following commands:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nv">transformed_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tft.TFTransformOutput<span class="o">(</span>TRANSFORM_ARTEFACTS_DIR<span class="o">)</span>.transformed_metadata
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>transformed_metadata.schema
</span></code></pre></div>
<p>The following code shows how you use the feature name to create feature columns:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_wide_and_deep_feature_columns</span><span class="p">():</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="n">deep_feature_columns</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    <span class="n">wide_feature_columns</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="c1"># Select features you've checked from the metadata</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="c1"># Categorical features are associated with the vocabulary size (starting from 0)</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>    <span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'mother_age_log'</span><span class="p">,</span> <span class="s1">'mother_age_normalized'</span><span class="p">,</span> <span class="s1">'gestation_weeks_scaled'</span><span class="p">]</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>    <span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">'is_male_index'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">'is_multiple_index'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>                            <span class="p">(</span><span class="s1">'mother_age_bucketized'</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s1">'mother_race_index'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">numeric_features</span><span class="p">:</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>        <span class="n">deep_feature_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="n">feature</span><span class="p">))</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>        <span class="n">inputs</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>    <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">vocab_size</span> <span class="ow">in</span> <span class="n">categorical_features</span><span class="p">:</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>        <span class="n">categorical_columns</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>            <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">categorical_column_with_identity</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">num_buckets</span><span class="o">=</span><span class="n">vocab_size</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>        <span class="n">wide_feature_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">indicator_column</span><span class="p">(</span><span class="n">categorical_columns</span><span class="p">[</span><span class="n">feature</span><span class="p">]))</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>        <span class="n">inputs</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'int64'</span><span class="p">)</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>    <span class="n">mother_race_X_mother_age_bucketized</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">crossed_column</span><span class="p">(</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>        <span class="p">[</span><span class="n">categorical_columns</span><span class="p">[</span><span class="s1">'mother_age_bucketized'</span><span class="p">],</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>         <span class="n">categorical_columns</span><span class="p">[</span><span class="s1">'mother_race_index'</span><span class="p">]],</span>  <span class="mi">55</span><span class="p">)</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>    <span class="n">wide_feature_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">indicator_column</span><span class="p">(</span><span class="n">mother_race_X_mother_age_bucketized</span><span class="p">))</span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>    <span class="n">mother_race_X_mother_age_bucketized_embedded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">embedding_column</span><span class="p">(</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>        <span class="n">mother_race_X_mother_age_bucketized</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>    <span class="n">deep_feature_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mother_race_X_mother_age_bucketized_embedded</span><span class="p">)</span>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a>    <span class="k">return</span> <span class="n">wide_feature_columns</span><span class="p">,</span> <span class="n">deep_feature_columns</span><span class="p">,</span> <span class="n">inputs</span>
</span></code></pre></div>
<p>The code creates a <code>tf.feature_column.numeric_column</code> column for numeric
features, and a <code>tf.feature_column.categorical_column_with_identity</code> column for
categorical features.</p>
<p>You can also create extended feature columns, as described in
<a href="../../../guide/tft_bestpractices#option-c-tensorflow">Option C: TensorFlow</a>
in the first part of this series. In the example used for this series, a new
feature is created, <code>mother_race_X_mother_age_bucketized</code>, by crossing the
<code>mother_race</code> and <code>mother_age_bucketized</code> features using the
<code>tf.feature_column.crossed_column</code> feature column. Low-dimensional, dense
representation of this crossed feature is created using the
<code>tf.feature_column.embedding_column</code> feature column.</p>
<p>The following diagram, figure 5, shows the transformed data and how the
transformed metadata is used to define and train the TensorFlow
model:</p>
<p><figure id="training-tf-with-transformed-data"><img alt="Training the TensorFlow model with transformed data." src="../images/data-preprocessing-for-ml-with-tf-transform-training-tf-model-with-transformed-data.svg"><figcaption>Figure 5: Training the TensorFlow model with the transformed data. </figcaption></figure></p>
<h3 id="export-the-model-for-serving-prediction">Export the model for serving prediction<a class="headerlink" href="#export-the-model-for-serving-prediction" title="Permanent link"></a></h3>
<p>After you train the TensorFlow model with the Keras API, you
export the trained model as a SavedModel object, so that it can serve new data
points for prediction. When you export the model, you have to define its
interfacethat is, the input features schema that is expected during serving.
This input features schema is defined in the <code>serving_fn</code> function, as shown in
the following code:</p>
<div class="language-py yaml no-copy highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">export_serving_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="n">tf_transform_output</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">TFTransformOutput</span><span class="p">(</span><span class="n">TRANSFORM_ARTEFACTS_DIR</span><span class="p">)</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>    <span class="c1"># The layer has to be saved to the model for Keras tracking purposes.</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="n">model</span><span class="o">.</span><span class="n">tft_layer</span> <span class="o">=</span> <span class="n">tf_transform_output</span><span class="o">.</span><span class="n">transform_features_layer</span><span class="p">()</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">serveing_fn</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">is_male</span><span class="p">,</span> <span class="n">mother_race</span><span class="p">,</span> <span class="n">mother_age</span><span class="p">,</span> <span class="n">plurality</span><span class="p">,</span> <span class="n">gestation_weeks</span><span class="p">):</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>        <span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>            <span class="s1">'is_male'</span><span class="p">:</span> <span class="n">is_male</span><span class="p">,</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>            <span class="s1">'mother_race'</span><span class="p">:</span> <span class="n">mother_race</span><span class="p">,</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>            <span class="s1">'mother_age'</span><span class="p">:</span> <span class="n">mother_age</span><span class="p">,</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>            <span class="s1">'plurality'</span><span class="p">:</span> <span class="n">plurality</span><span class="p">,</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>            <span class="s1">'gestation_weeks'</span><span class="p">:</span> <span class="n">gestation_weeks</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>        <span class="p">}</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>        <span class="n">transformed_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tft_layer</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">transformed_features</span><span class="p">)</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>        <span class="c1"># The prediction results have multiple elements in general.</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>        <span class="c1"># But we need only the first element in our case.</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">outputs</span><span class="p">)</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">'uid'</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>    <span class="n">concrete_serving_fn</span> <span class="o">=</span> <span class="n">serveing_fn</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">(</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>        <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'uid'</span><span class="p">),</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>        <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'is_male'</span><span class="p">),</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>        <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'mother_race'</span><span class="p">),</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>        <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'mother_age'</span><span class="p">),</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>        <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'plurality'</span><span class="p">),</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>        <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'gestation_weeks'</span><span class="p">)</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>    <span class="p">)</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>    <span class="n">signatures</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'serving_default'</span><span class="p">:</span> <span class="n">concrete_serving_fn</span><span class="p">}</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s1">'tf'</span><span class="p">,</span> <span class="n">signatures</span><span class="o">=</span><span class="n">signatures</span><span class="p">)</span>
</span></code></pre></div>
<p>During serving, the model expects the data points in their raw form (that is,
raw features before transformations). Therefore, the <code>serving_fn</code> function
receives the raw features and stores them in a <code>features</code> object as a Python
dictionary. However, as discussed earlier, the trained model expects the data
points in the transformed schema. To convert the raw features into the
<code>transformed_features</code> objects that are expected by the model interface, you
apply the saved <code>transform_fn</code> graph to the <code>features</code> object with the
following steps:</p>
<ol>
<li>
<p>Create the <code>TFTransformOutput</code> object from the artifacts generated and
    saved in the previous preprocessing step:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">tf_transform_output</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">TFTransformOutput</span><span class="p">(</span><span class="n">TRANSFORM_ARTEFACTS_DIR</span><span class="p">)</span>
</span></code></pre></div>
</li>
<li>
<p>Create a <code>TransformFeaturesLayer</code> object from the <code>TFTransformOutput</code>
    object:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">model</span><span class="o">.</span><span class="n">tft_layer</span> <span class="o">=</span> <span class="n">tf_transform_output</span><span class="o">.</span><span class="n">transform_features_layer</span><span class="p">()</span>
</span></code></pre></div>
</li>
<li>
<p>Apply the <code>transform_fn</code> graph using the <code>TransformFeaturesLayer</code> object:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">transformed_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tft_layer</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
</span></code></pre></div>
</li>
</ol>
<p>The following diagram, figure 6, illustrates the final step of exporting a model
for serving:</p>
<p><figure id="exporting-model-for-serving-with-transform_fn"><img alt="Exporting the model for serving with the transform_fn graph attached." src="../images/data-preprocessing-for-ml-with-tf-transform-exporting-model-for-serving-with-transform_fn.svg"><figcaption>Figure 6: Exporting the model for serving with the <code>transform_fn</code> graph attached. </figcaption></figure></p>
<h2 id="train-and-use-the-model-for-predictions">Train and use the model for predictions<a class="headerlink" href="#train-and-use-the-model-for-predictions" title="Permanent link"></a></h2>
<p>You can train the model locally by executing the cells of the notebook. For
examples of how to package the code and train your model at scale using
Vertex AI Training, see the samples and guides in the Google Cloud
<a href="https://github.com/GoogleCloudPlatform/cloudml-samples">cloudml-samples</a>
GitHub repository.</p>
<p>When you inspect the exported SavedModel object using the <code>saved_model_cli</code>
tool, you see that the <code>inputs</code> elements of the signature definition
<code>signature_def</code> include the raw features, as shown in the following example:</p>
<div class="language-py yaml no-copy highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">signature_def</span><span class="p">[</span><span class="s1">'serving_default'</span><span class="p">]:</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>  <span class="n">The</span> <span class="n">given</span> <span class="n">SavedModel</span> <span class="n">SignatureDef</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">following</span> <span class="nb">input</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>    <span class="n">inputs</span><span class="p">[</span><span class="s1">'gestation_weeks'</span><span class="p">]</span> <span class="n">tensor_info</span><span class="p">:</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">DT_FLOAT</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>        <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>        <span class="n">name</span><span class="p">:</span> <span class="n">serving_default_gestation_weeks</span><span class="p">:</span><span class="mi">0</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="n">inputs</span><span class="p">[</span><span class="s1">'is_male'</span><span class="p">]</span> <span class="n">tensor_info</span><span class="p">:</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">DT_STRING</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>        <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>        <span class="n">name</span><span class="p">:</span> <span class="n">serving_default_is_male</span><span class="p">:</span><span class="mi">0</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>    <span class="n">inputs</span><span class="p">[</span><span class="s1">'mother_age'</span><span class="p">]</span> <span class="n">tensor_info</span><span class="p">:</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">DT_FLOAT</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>        <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>        <span class="n">name</span><span class="p">:</span> <span class="n">serving_default_mother_age</span><span class="p">:</span><span class="mi">0</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>    <span class="n">inputs</span><span class="p">[</span><span class="s1">'mother_race'</span><span class="p">]</span> <span class="n">tensor_info</span><span class="p">:</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">DT_STRING</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>        <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>        <span class="n">name</span><span class="p">:</span> <span class="n">serving_default_mother_race</span><span class="p">:</span><span class="mi">0</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>    <span class="n">inputs</span><span class="p">[</span><span class="s1">'plurality'</span><span class="p">]</span> <span class="n">tensor_info</span><span class="p">:</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">DT_FLOAT</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>        <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>        <span class="n">name</span><span class="p">:</span> <span class="n">serving_default_plurality</span><span class="p">:</span><span class="mi">0</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>    <span class="n">inputs</span><span class="p">[</span><span class="s1">'uid'</span><span class="p">]</span> <span class="n">tensor_info</span><span class="p">:</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">DT_STRING</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a>        <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>        <span class="n">name</span><span class="p">:</span> <span class="n">serving_default_uid</span><span class="p">:</span><span class="mi">0</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>  <span class="n">The</span> <span class="n">given</span> <span class="n">SavedModel</span> <span class="n">SignatureDef</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">following</span> <span class="n">output</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>    <span class="n">outputs</span><span class="p">[</span><span class="s1">'uid'</span><span class="p">]</span> <span class="n">tensor_info</span><span class="p">:</span>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">DT_STRING</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a>        <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a>        <span class="n">name</span><span class="p">:</span> <span class="n">StatefulPartitionedCall_6</span><span class="p">:</span><span class="mi">0</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a>    <span class="n">outputs</span><span class="p">[</span><span class="s1">'weight'</span><span class="p">]</span> <span class="n">tensor_info</span><span class="p">:</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">DT_FLOAT</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a>        <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>        <span class="n">name</span><span class="p">:</span> <span class="n">StatefulPartitionedCall_6</span><span class="p">:</span><span class="mi">1</span>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a>  <span class="n">Method</span> <span class="n">name</span> <span class="ow">is</span><span class="p">:</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">serving</span><span class="o">/</span><span class="n">predict</span>
</span></code></pre></div>
<p>The remaining cells of the notebook show you how to use the exported model for
a local prediction, and how to deploy the model as a microservice using
Vertex AI Prediction. It is important to highlight that the input (sample)
data point is in the raw schema in both cases.</p>
<h2 id="clean-up">Clean up<a class="headerlink" href="#clean-up" title="Permanent link"></a></h2>
<p>To avoid incurring additional charges to your Google Cloud account for the
resources used in this tutorial, delete the project that contains the resources.</p>
<h3 id="delete-the-project">Delete the project<a class="headerlink" href="#delete-the-project" title="Permanent link"></a></h3>
<div class="admonition danger">
<p class="admonition-title">Caution</p>
<p>Deleting a project has the following effects:</p>
<ul>
<li><strong>Everything in the project is deleted.</strong> If you used an existing project for
  this tutorial, when you delete it, you also delete any other work you've done in the project.</li>
<li><strong>Custom project IDs are lost.</strong> When you created this project, you might have created a custom project ID that you want to use in the future. To preserve the URLs that use the project ID, such as an <code dir="ltr" translate="no">appspot.com</code> URL, delete selected resources inside the project instead of deleting the whole project.</li>
</ul>
<p>If you plan to explore multiple tutorials and quickstarts, reusing projects can help you avoid exceeding project quota limits.</p>
</div>
<ol>
<li>In the Google Cloud console,
   go to the <strong>Manage resources</strong> page.</li>
</ol>
<p><a class="md-button md-button--primary" href="https://console.cloud.google.com/iam-admin/projects">Go to Manage resources</a></p>
<ol>
<li>In the project list, select the project that you want to delete, and then
   click <strong>Delete</strong>.</li>
<li>In the dialog, type the project ID, and then click <strong>Shut down</strong> to delete
   the project.</li>
</ol>
<h2 id="whats-next">What's next<a class="headerlink" href="#whats-next" title="Permanent link"></a></h2>
<ul>
<li>To learn about the concepts, challenges, and options of data
    preprocessing for machine learning on Google Cloud, see the first
    article in this series,
    <a href="../../../guide/tft_bestpractices">Data preprocessing for ML: options and recommendations</a>.</li>
<li>For more information about how to implement, package, and run a
    tf.Transform pipeline on Dataflow, see the
    <a href="https://github.com/GoogleCloudPlatform/cloudml-samples/tree/master/census/tftransformestimator">Predicting income with Census Dataset</a>
    sample.</li>
<li>Take the Coursera specialization on ML with
    <a href="https://www.coursera.org/specializations/machine-learning-tensorflow-gcp">TensorFlow on Google Cloud</a>.</li>
<li>Learn about best practices for ML engineering in
    <a href="https://developers.google.com/machine-learning/guides/rules-of-ml/">Rules of ML</a>.</li>
<li>For more reference architectures, diagrams, and best practices, explore the
    <a href="https://cloud.google.com/architecture">Cloud Architecture Center</a>.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "content.code.select", "content.action.edit"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>